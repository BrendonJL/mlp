# 2026-01-15 - Phase 5: Frame Skip Implementation & BREAKTHROUGH!

## Session Focus
Implemented `SkipFrameWrapper` to solve the "Tall Pipe Problem" - and it worked immediately!

## Major Accomplishments

### 1. SkipFrameWrapper Implementation
Built a frame skip wrapper that repeats each action for multiple frames:

```python
class SkipFrameWrapper(gym.Wrapper):
    def __init__(self, env, skip=4):
        super().__init__(env)
        self.skip = max(skip, 1)  # Defensive: ensure at least 1

    def step(self, action):
        total_reward = 0.0
        obs = None
        terminated = False
        truncated = False
        info = {}
        for _ in range(self.skip):
            obs, reward, terminated, truncated, info = self.env.step(action)
            total_reward += reward
            if terminated or truncated:
                break
        return (obs, total_reward, terminated, truncated, info)
```

**Key Design Decisions:**
- Used `max(skip, 1)` to prevent edge case where skip=0 would cause empty loop
- Pre-initialized variables to satisfy static analysis (linter warning about "possibly unbound")
- Used `_` for loop variable since we don't need the index (Python convention)
- Accumulates reward across all frames, returns final observation

### 2. Full Config Chain Integration
Integrated frame_skip through the entire system:

```
ppo_v4.yaml (frame_skip: 4)
    ↓
train.py (reads config["environment"]["frame_skip"])
    ↓
make_vec_mario_env(skip=frame_skip)
    ↓
make_mario_env(skip=skip)
    ↓
SkipFrameWrapper(env, skip=skip)
```

**Files Modified:**
- `src/environments/wrappers.py` - Added SkipFrameWrapper class
- `src/environments/mario_env.py` - Added skip parameter, integrated wrapper after CompatibilityWrapper
- `src/environments/vec_mario_env.py` - Added skip parameter passthrough
- `src/training/train.py` - Reads frame_skip from config, passes to environment
- `configs/ppo_v4.yaml` - New config with frame_skip: 4

### 3. Test Run Results - BREAKTHROUGH!
Ran 50k step test and the results were **immediate and dramatic**:

| Episode | Distance | Reward | Notes |
|---------|----------|--------|-------|
| 1 | 722 px | 1,792 | Right at the pipe |
| 2 | **1,422 px** | 3,043 | Past the pipe! |
| 3 | 1,136 px | 2,100 | Consistent |
| 5 | **1,405 px** | 1,740 | Consistent |
| 11 | **1,425 px** | 2,359 | Breakthrough confirmed! |

**The agent broke through the 722 barrier within the first 16k timesteps!**

This is the obstacle that took PPO v3 millions of steps to overcome, and PPO v2 never managed to pass consistently.

### 4. Directory Cleanup
Removed unused empty directories:
- ❌ `src/preprocessing/` - Preprocessing is in wrappers.py
- ❌ `src/models/` - Using SB3's built-in CnnPolicy
- ❌ `src/agents/` - Using SB3's DQN/PPO directly

Kept Phase 7 placeholders:
- ✅ `docker/` - Containerization planned
- ✅ `tests/` - Unit tests planned
- ✅ `.github/workflows/` - CI/CD planned

### 5. Documentation Updates
- Updated README.md directory structure
- Updated ProjectDocumentation.md directory structure
- Added ppo_v4.yaml to config listings
- Updated Phase 5 Part E status to complete
- Added frame skip learnings to Key Learnings section

## Technical Learnings

### Why Frame Skip Solves the Tall Pipe Problem
Without frame skip (60 FPS):
- High jump requires holding button for 0.5 seconds
- = 30 consecutive "jump" action outputs
- Random chance of this: (1/7)^30 ≈ 0 (essentially impossible)

With frame skip (skip=4):
- Same high jump = only ~7 consecutive "jump" decisions
- Random chance: (1/7)^7 ≈ 0.00001 (still rare, but possible!)
- **4x reduction in exploration difficulty**

### Wrapper Order Matters
```
JoypadSpace → CompatibilityWrapper → SkipFrameWrapper → RewardShapingWrapper → Grayscale → Resize → FrameStack → Transpose
```

SkipFrame goes **before** preprocessing because:
1. We skip raw frames (less computation)
2. We only preprocess the frames we keep
3. Reward shaping needs to see accumulated rewards from skipped frames

### Defensive Programming Patterns
- `max(skip, 1)` prevents skip=0 edge case
- Pre-initializing variables before loops satisfies static analysis
- Using `.get("key", default)` for optional config values

### Config Chain Design
Making `skip` configurable through the full chain allows experimentation:
- `skip=2`: Less temporal abstraction, faster but harder to learn
- `skip=4`: Standard Atari setting, good balance
- `skip=8`: More temporal abstraction, might miss precise timing

## Files Created/Modified

### New Files
- `configs/ppo_v4.yaml` - Frame skip configuration
- `docs/daily/2026-01-15.md` - This daily log

### Modified Files
- `src/environments/wrappers.py` - Added SkipFrameWrapper
- `src/environments/mario_env.py` - Added skip parameter
- `src/environments/vec_mario_env.py` - Added skip parameter
- `src/training/train.py` - Reads frame_skip from config
- `README.md` - Updated directory structure and status
- `docs/ProjectDocumentation.md` - Updated directory structure and Phase 5 status

### Deleted Files/Directories
- `src/preprocessing/` (empty)
- `src/models/` (empty)
- `src/agents/` (empty)

## Training Status
**PPO v4 with frame skip - 10M step run in progress!**

Early metrics (16k steps):
- `ep_rew_mean`: 1,790 (already matching PPO v3 final performance!)
- `approx_kl`: 0.0079 (healthy)
- `explained_variance`: 0.544 (reasonable)
- `fps`: 73

## Key Insight
Frame skip is **transformative** for temporal action problems. The "Tall Pipe Problem" wasn't about algorithm choice (DQN vs PPO) or hyperparameter tuning - it was about the fundamental difficulty of discovering that "hold jump longer = jump higher" through random exploration.

By making each action persist for 4 frames, we reduced the search space by 4x and made the high-jump behavior **discoverable** through normal exploration.

This is why frame skip is **standard practice** in Atari RL - not for computational savings, but because it makes temporal behaviors learnable.

---

**Training Status:** PPO v4 (10M steps with frame skip) in progress
**Next Session:** Evaluate v4 results, create comparison with v3
